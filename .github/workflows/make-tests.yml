name: Run Makefile-based tests

on:
  workflow_dispatch:
  pull_request:
    branches: [ master, main-* ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-deep-tests:
     uses: ./.github/workflows/check-deep-tests-reusable.yml

  run-make-tests:
    needs: check-deep-tests
    if: always() && (( github.event_name == 'pull_request' && (needs.check-deep-tests.result == 'success' || contains(github.event.pull_request.labels.*.name, 'run-deep-tests'))) || ( github.event_name == 'push' && ( github.ref_name == 'master' || vars.TEST_ON_FORK == 'true' )))

    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [
          DafnyCore,
          DafnyRuntime,
          DafnyRuntime/DafnyRuntimeDafny,
          DafnyRuntime/DafnyRuntimeGo,
          DafnyRuntime/DafnyRuntimeJava,
          DafnyRuntime/DafnyRuntimePython,
          DafnyRuntime/DafnyRuntimeJs,
          DafnyStandardLibraries
        ]
      fail-fast: false
    steps:
      - name: Checkout Dafny
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Set up JDK 18
        uses: actions/setup-java@v3
        with:
          java-version: 18
          distribution: corretto
      - name: Build Dafny
        run: dotnet build Source/Dafny.sln
      - name: Get Z3
        run: make z3-ubuntu
      - run: npm install bignumber.js
      - name: Test ${{ matrix.project }}
        run: |
          cd ./Source/${{ matrix.project }}
          make test
